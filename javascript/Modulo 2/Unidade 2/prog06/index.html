<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB</title>
    <script>
        let db;
        let reqdb = indexedDB.open("MinhaBaseDeDados", 1);
        reqdb.onsuccess = () => {
            db = reqdb.result;
            console.log("Banco de dados aberto com sucesso.");
        }
        reqdb.onerror = (e) => {
            console.log(reqdb.error);
            console.log("Erro ao abrir o banco de dados: " + e.target.errorCode);
        }
        reqdb.onupgradeneeded = (e) => {
            db = reqdb.result;
            if (!db.objectStoreNames.contains("Livros")) {
                let objStore = db.createObjectStore("Livros", { keyPath: "id" });
                objStore.createIndex("TituloIDX", "titulo", { unique: false });
                objStore.createIndex("AutorIDX", "autor", { unique: false });
                console.log("Object store 'Livros' criada com sucesso.");
            }
        }
        onload = () => {
            btnC.onclick = () => {
                let livro = {
                    id: parseInt(idLivro.value),
                    titulo: titulo.value,
                    autor: autor.value
                };
                let transaction = db.transaction(["Livros"], "readwrite");
                let livrosOs = transaction.objectStore("Livros");
                let reqAdd = livrosOs.add(livro);
                reqAdd.onsuccess = () => {
                    console.log("Livro adicionado com sucesso.");
                }
                reqAdd.onerror = () => {
                    console.log("Erro ao adicionar o livro: " + reqAdd.error);
                }
            }

            btnR.onclick = () => {
                db.
                    transaction("Livros")
                    .objectStore("Livros")
                    .get(parseInt(idLivro.value)).onsuccess = (e) => {
                        titulo.value = e.target.result.titulo;
                        autor.value = e.target.result.autor;
                    }
            }

            btnD.onclick = () => {
                db.
                    transaction(["Livros"], 'readwrite')
                    .objectStore("Livros")
                    .delete(parseInt(idLivro.value)).onsuccess = (e) => {
                        console.log("Livro excluido");
                    }
            }

            btnU.onclick = () => {
                db.
                    transaction(["Livros"], 'readwrite')
                    .objectStore("Livros")
                    .put({
                        id: parseInt(idLivro.value),
                        titulo: titulo.value,
                        autor: autor.value
                    }).onsuccess = (e) => {
                        console.log("Livro atualizado");
                    }

            }

            btnL.onclick = () => {
                db.
                    transaction("Livros")
                    .objectStore("Livros")
                    .openCursor().onsuccess = (e) => {
                        let cursor = e.target.result;
                        if (cursor) {
                            console.log(`ID: ${cursor.key}, Título: ${cursor.value.titulo}, Autor: ${cursor.value.autor}`);
                            cursor.continue();
                        } else {
                            console.log("Todos os livros foram listados.");
                        }
                    }

            }

            btnRT.onclick = () => {
                db.
                    transaction("Livros")
                    .objectStore("Livros")
                    .index("TituloIDX")
                    .get(titulo.value).onsuccess = (e) => {
                        idLivro.value = e.target.result.id;
                        titulo.value = e.target.result.titulo;
                        autor.value = e.target.result.autor;
                        console.log(e.target.result);
                    }
            }

            btnLA.onclick = () => {
                db.
                    transaction("Livros")
                    .objectStore("Livros")
                    .index("AutorIDX")
                    .getAll(IDBKeyRange.only(autor.value)).onsuccess = (e) => {
                        console.log(e.target.result);
                    }

            }
        }
    </script>
</head>

<body>
    <h1>IndexedDB</h1>
    <p><label for="idLivro">ID:</label><input type="number" id="idLivro" /></p>
    <p><label for="titulo">Título:</label><input type="text" id="titulo" /></p>
    <p><label for="autor">Autor:</label><input type="text" id="autor" /></p>
    <p>
        <button id="btnC">Incluir</button>
        <button id="btnR">Ler</button>
        <button id="btnD">Excluir</button>
        <button id="btnU">Atualizar</button>
        <button id="btnL">Listar</button>
        <button id="btnRT">Ler por Título</button>
        <button id="btnLA">Listagem por Autor</button>
    </p>
</body>

</html>